<app-header></app-header>

<section class="hero-title">
  <div class="hero-content">
    <h2>
      <mat-icon>calendar_today</mat-icon>
      <span *ngIf="utente?.tipologia === 'admin'; else prenotazioniUser">Gestione Prenotazioni</span>
      <ng-template #prenotazioniUser> Prenotazioni</ng-template>
    </h2>
    <p>
      <ng-container *ngIf="utente?.tipologia === 'admin'; else userText">
        Visualizza e gestisci tutte le prenotazioni
      </ng-container>
      <ng-template #userText>
        Visualizza e gestisci le tue prenotazioni
      </ng-template>
    </p>
  </div>
</section>


<div class="bookings-container">
  <!-- Header Actions -->
  <div class="header-actions">
    <a class="btn btn-primary" href="/gestione_prenotazioni">
      <mat-icon>refresh</mat-icon> Aggiorna
    </a>
  </div>

  <div class="bookings-list" id="bookingsList">

    <ng-template #noPrenotazioni>
      <div class="no-bookings">
        <mat-icon>calendar_today</mat-icon>
        <h3>Nessuna prenotazione trovata</h3>
      </div>
    </ng-template>

    <ng-container *ngIf="prenotazioni.length > 0; else noPrenotazioni">
      <div *ngFor="let p of prenotazioni" class="booking-card">
        <div class="booking-header">
          <div class="booking-info">
            <div class="booking-guest">Prenotazione n.{{ p.id }}</div>
            <div class="booking-meta">
              <span><mat-icon>login</mat-icon> Check-in: {{ p.dataCheckIn | date:'dd/MM/yyyy' }}</span>
              <span><mat-icon>logout</mat-icon> Check-out: {{ p.dataCheckOut | date:'dd/MM/yyyy' }}</span>
              <span><mat-icon>king_bed</mat-icon> Numero camera: {{ p.cameraId }}</span>
              <span><mat-icon>euro_symbol</mat-icon> Totale: {{ p.totale | currency:'EUR' }}</span>
            </div>
          </div>

          <div class="booking-actions">
            <div *ngIf="utente?.tipologia === 'admin'" class="admin-popup-container">
              <mat-icon class="info-icon" (click)="toggleUserPopup(p.id!)">account_circle</mat-icon>
              <div class="admin-popup" *ngIf="activePopupId === p.id">
                <ng-container *ngIf="getUtenteById(p.utenteId) as user; else loadingUser">
                  <strong>ID Utente:</strong> {{ p.utenteId }}<br>
                  <strong>Nome:</strong> {{ user.nome || 'N/A' }}<br>
                  <strong>Cognome:</strong> {{ user.cognome || 'N/A' }}<br>
                  <strong>Telefono:</strong> {{ user.telefono || 'N/A' }}<br>
                  <strong>Email:</strong> {{ user.email || 'N/A' }}<br>
                </ng-container>
                <ng-template #loadingUser>
                  <em>Caricamento dati utente...</em>
                </ng-template>
              </div>
            </div>

            <button class="btn-delete" (click)="eliminaPrenotazione(p.id!)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </ng-container>
  </div>
</div>

<div *ngIf="loading" class="loading-overlay">
  <div class="spinner"></div>
  <p>Caricamento...</p>
</div>

<div *ngIf="popupMessage" class="popup-overlay">
  <div class="popup-box">
    <p>{{ popupMessage }}</p>
    <button (click)="chiudiPopup()" class="btn btn-primary">OK</button>
  </div>
</div>

<app-footer></app-footer>
